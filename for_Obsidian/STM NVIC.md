#stm  #interrupt
[[STM]]

**NVIC (Nested Vectored Interrupt Controller)** — это модуль в микроконтроллерах ARM Cortex-M, который управляет обработкой прерываний. Он позволяет системе обрабатывать внешние и внутренние события (например, прием данных по UART, таймеры, ошибки и другие аппаратные сигналы).

#### Основные функции NVIC:

1. **Прием запросов на прерывания:**  
    NVIC получает сигналы от различных периферийных устройств, таких как UART, I2C, SPI, таймеры и т.д.
    
2. **Приоритизация прерываний:**  
    NVIC поддерживает вложенную (nested) обработку прерываний благодаря гибкому механизму управления приоритетами. Прерывания с более высоким приоритетом могут прерывать обработку прерываний с более низким приоритетом.
    
3. **Векторизация:**  
    Каждое прерывание связано с определенным адресом обработчика (вектором), который NVIC вызывает автоматически при возникновении события.
    
4. **Разрешение и маскирование прерываний:**  
    Можно включать или отключать отдельные прерывания через регистры NVIC.
    
### Принцип работы NVIC:

1. **Запрос прерывания:**  
   Устройство периферии (например, USART) устанавливает флаг прерывания.
   
2. **Приоритетное определение:**  
   NVIC проверяет приоритет всех активных прерываний и выбирает прерывание с наивысшим приоритетом.
   
3. **Переход к обработчику:**  
   Процессор сохраняет контекст текущего выполнения и передает управление функции-обработчику прерывания (`IRQHandler`).
   
4. **Возврат к основной программе:**  
   После завершения обработчика процессор восстанавливает контекст и продолжает выполнение основного кода.

### Управление прерываниями

Для работы с NVIC на уровне кода обычно используются следующие функции:

1.  **Включение прерывания**

```c
nvic_enable_irq(NVIC_USART1_IRQ);  // Разрешить прерывание USART1
```

2. **Установка приоритета**
```c
nvic_set_priority(NVIC_USART1_IRQ, 2);  // Установить приоритет прерывания
```

3. **Отключение прерывания**
```c
nvic_disable_irq(NVIC_USART1_IRQ);  // Отключить прерывание USART1
```

### Приоритеты прерываний

- В Cortex-M можно задать до 256 уровней приоритетов.
- Более низкие значения приоритета означают более высокий приоритет (`0` — максимальный).
- Прерывания с одинаковым приоритетом обрабатываются по порядку их поступления.

### Пример минимальной конфигурации для работы NVIC:
```c
nvic_enable_irq(NVIC_USART1_IRQ);        // Включаем прерывание для USART1
nvic_set_priority(NVIC_USART1_IRQ, 1);   // Задаем высокий приоритет
usart_enable_rx_interrupt(USART1);       // Включаем прерывание по приему данных
```