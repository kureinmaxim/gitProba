# Проект primGPT ->  STM32F1 с FreeRTOS, UART, SPI FRAM и CRC16  

## Обзор  

Этот проект представляет собой встраиваемую систему на базе микроконтроллера STM32F1xx, использующую операционную систему реального времени FreeRTOS. Проект демонстрирует:

*   Работу с несколькими задачами FreeRTOS.
*   Взаимодействие с периферией: UART (для команд и логирования), SPI (для работы с FRAM), GPIO (для управления светодиодами).
*   Прием команд по UART с использованием прерываний, таймаута для определения конца пакета и проверки целостности данных с помощью CRC16.
*   Запись и чтение данных во внешнюю память FRAM по интерфейсу SPI.
*   Использование отдельного UART для вывода отладочной информации и логов.  

## Требования к Оборудованию  

*   Микроконтроллер STM32F1xx (например, STM32F103C8T6).
*   Внешняя память FRAM с интерфейсом SPI (например, FM25L16B или аналогичная), подключенная к SPI1 (PA5-SCK, PA6-MISO, PA7-MOSI, PA4-CS).
*   Два преобразователя USB-to-UART:
    *   Один для `USART1` (PA9-TX, PA10-RX) - используется для приема команд и отправки ответов. Скорость: 38400 бод.
    *   Один для `USART3` (PB10-TX, PB11-RX) - используется для логирования. Скорость: 115200 бод.
*   Светодиод, подключенный к `PC13`.
*   (Опционально) Светодиод, подключенный к `PC15` (используется для индикации работы `Uart1Task`).  

## Программное Обеспечение и Среда Разработки  

*   **IDE:** STM32CubeIDE
*   **Компилятор:** ARM GCC
*   **Библиотеки:**
    *   STM32Cube HAL
    *   FreeRTOS (с интерфейсом CMSIS-OS v1/v2)

*   **Утилита для терминала:** Любая программа для работы с COM-портом (например, PuTTY, Tera Term, CoolTerm). 

## Функциональность  

### Операционная Система Реального Времени (FreeRTOS)  

Проект использует FreeRTOS для управления задачами:  

1.  **`LedTask`:** (Приоритет: Normal)
    *   Периодически (каждые 5 секунд) переключает состояние светодиода на `PC13`.
    *   Отправляет символ 'A' через `USART1`.

1.  **`Uart1Task`:** (Приоритет: AboveNormal)
    *   Основная задача для обработки команд, поступающих по `USART1`.
    *   Ожидает поступления байтов в очередь `uartQueue`, которая заполняется в обработчике прерывания `USART1`.
    *   Собирает байты в буфер `command`.
    *   Использует таймаут (`UART_TIMEOUT_MS` = 50 мс) после приема последнего байта для определения конца пакета.
    *   Проверяет CRC16 полученного пакета (исключая два последних байта CRC).
    *   В случае корректного CRC выполняет команды.
    *   Отправляет маркер конца обработки (`0xEE 0xFF`) по `USART1`.
    *   Периодически мигает светодиодом на `PC15`.8

3.  **`defaultTask`:** (Приоритет: Normal)

    *   Задача по умолчанию, генерируемая CubeMX.
    *   Периодически выводит системное время (Tick) через `USART3`.  

### Коммуникация по UART1 (Командный Интерфейс)  

*   **Прием:** Осуществляется через прерывания `USART1`. Полученный байт помещается в очередь `uartQueue`. Задача `Uart1Task` извлекает байты из очереди.
*   **Формат пакета:** `[Байт_Команды] [Байты_Данных...] [CRC16_LSB] [CRC16_MSB]`
*   **CRC16:** Используется полином `0xA001`, начальное значение `0xFFFF`. CRC рассчитывается для всех байтов пакета, кроме последних двух (самого CRC).

*   **Поддерживаемые Команды:**

    *   `[0x00] [0x00] [CRC_L] [CRC_H]`: Выключить светодиод (PC13 = 1, т.к. инверсная логика).
    *   `[0x01] [0x01] [CRC_L] [CRC_H]`: Включить светодиод (PC13 = 0).
    *   `[0x02] [0x00] [CRC_L] [CRC_H]`: Записать строку "KUREIN" в FRAM по адресу `0x0150`, затем прочитать ее обратно (для проверки).

*   **Ответ:** После обработки (успешной или неуспешной по CRC) команды добавляется маркер конца посылки `0xEE 0xFF`.  

### Работа с FRAM (SPI1)  

*   Используется интерфейс SPI1 в режиме Master.
*   Управление линией Chip Select (CS) осуществляется программно через `PA4`.
*   Реализованы функции для инициализации (`fram_init`), чтения (`fram_read`), записи (`fram_write`), управления записью (`fram_write_enable`/`fram_write_disable`), чтения/записи регистра статуса и полной очистки памяти (`fram_erase_all`).  

### Логирование (UART3)  

*   `USART3` настроен на скорость 115200 бод.
*   Используется для вывода системных сообщений, отладочной информации и значений времени с помощью функций `log_printf()` и `printf_uart3()`.  

### CRC16  

*   Реализация расчета CRC16 находится в `crc16.c`.
*   Функция `process_crc()` используется для проверки CRC принятых пакетов в `Uart1Task`.  

## Сборка и Запуск  

1.  Откройте проект в STM32CubeIDE.
2.  Соберите проект (Project -> Build All).
3.  Прошейте микроконтроллер (Run -> Debug или Run -> Run).
4.  Подключите два USB-UART преобразователя:
    *   Один к пинам `PA9`/`PA10` (USART1). Откройте терминал с настройками 38400, 8N1.
    *   Второй к пинам `PB10`/`PB11` (USART3). Откройте терминал с настройками 115200, 8N1.
1.  В терминале USART3 вы должны увидеть сообщения о запуске задач и периодический вывод системного времени.
2.  В терминале USART1 вы можете отправлять команды в указанном формате (не забудьте рассчитать и добавить CRC16). Вы также будете видеть символ 'A', отправляемый `LedTask` каждые 5 секунд, и ответ `0xEE 0xFF` после отправки команды. 

## Структура Проекта  

*   `Core/Inc`: Заголовочные файлы проекта (`main.h`, `uart.h`, `fram.h`, `crc16.h`, `DataFile.h`, `FreeRTOSConfig.h` и т.д.).
*   `Core/Src`: Исходные файлы проекта (`main.c`, `uart.c`, `fram.c`, `crc16.c`, `stm32f1xx_it.c`, `freertos.c` и т.д.).
*   `Drivers`: Драйверы HAL и CMSIS.
*   `Middlewares`: Исходные коды FreeRTOS.
*   `.ioc`: Файл конфигурации STM32CubeMX.